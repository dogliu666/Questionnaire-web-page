<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI绘画负性评价原因探究 | 数据管理</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .data-preview {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .success {
            background-color: #d5f5e3;
            color: #27ae60;
        }
        
        .error {
            background-color: #fadbd8;
            color: #c0392b;
        }
        
        .file-upload {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>实验数据管理</h1>
            <p class="subtitle">查看、导出和管理您的实验数据</p>
        </header>
        
        <section>
            <h2>当前本地存储的数据</h2>
            
            <div class="action-buttons">
                <button id="view-data" class="btn-primary">查看数据</button>
                <button id="export-data" class="btn-primary btn-success">导出数据</button>
                <button id="export-csv" class="btn-primary btn-success">导出CSV</button>
                <button id="export-excel" class="btn-primary btn-success">导出Excel</button>
                <button id="clear-data" class="btn-primary btn-danger">清除数据</button>
            </div>
            
            <div id="data-preview" class="data-preview hidden"></div>
            
            <div id="status-message" class="status-message hidden"></div>
            
            <h2>导入数据</h2>
            <div class="file-upload">
                <input type="file" id="data-file" accept=".json">
                <button id="import-data" class="btn-primary btn-warning">导入</button>
            </div>
            
            <div class="notice-box">
                <h3>数据管理说明</h3>
                <ul>
                    <li>所有实验数据都存储在您的浏览器本地存储中</li>
                    <li>建议定期导出数据，以防浏览器数据被清除</li>
                    <li>导入功能可用于恢复之前导出的数据</li>
                    <li>请勿随意清除数据，除非您确认已完成实验并已导出数据</li>
                </ul>
            </div>
            
            <div class="form-actions">
                <a href="index.html" class="btn-primary">返回首页</a>
            </div>
        </section>
        
        <footer>
            <p>© 2025 AI绘画研究项目组 | 如有问题请联系: research@example.com</p>
        </footer>
    </div>
    
    <script>
        /**
         * 数据管理页面的脚本
         * 处理数据的查看、导出和简单分析
         */

        document.addEventListener('DOMContentLoaded', () => {
            const viewDataBtn = document.getElementById('view-data');
            const exportDataBtn = document.getElementById('export-data');
            const clearDataBtn = document.getElementById('clear-data');
            const importDataBtn = document.getElementById('import-data');
            const dataPreview = document.getElementById('data-preview');
            const statusMessage = document.getElementById('status-message');

            // 查看数据
            viewDataBtn.addEventListener('click', () => {
                const userData = localStorage.getItem('userData');
                
                if (userData) {
                    try {
                        const parsedData = JSON.parse(userData);
                        // 添加一些基本统计
                        addBasicStatistics(parsedData);
                        const formattedData = JSON.stringify(parsedData, null, 2);
                        dataPreview.textContent = formattedData;
                        dataPreview.classList.remove('hidden');
                        showStatus('数据加载成功', 'success');
                    } catch (error) {
                        showStatus('数据格式错误: ' + error.message, 'error');
                    }
                } else {
                    showStatus('本地存储中没有实验数据', 'error');
                    dataPreview.classList.add('hidden');
                }
            });
            
            // 导出数据为JSON
            exportDataBtn.addEventListener('click', () => {
                exportData('json');
            });
            
            // 导出数据为CSV
            document.getElementById('export-csv').addEventListener('click', () => {
                exportData('csv');
            });
            
            // 导出数据为Excel
            document.getElementById('export-excel').addEventListener('click', () => {
                exportData('excel');
            });
            
            // 清除数据
            clearDataBtn.addEventListener('click', () => {
                if (confirm('确定要清除所有实验数据吗？此操作无法撤销！')) {
                    localStorage.removeItem('userData');
                    dataPreview.classList.add('hidden');
                    showStatus('数据已成功清除', 'success');
                }
            });
            
            // 导入数据
            importDataBtn.addEventListener('click', () => {
                const fileInput = document.getElementById('data-file');
                const file = fileInput.files[0];
                
                if (file) {
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        try {
                            // 验证JSON格式
                            const jsonData = JSON.parse(event.target.result);
                            
                            // 确认要覆盖现有数据
                            if (localStorage.getItem('userData') && !confirm('导入将覆盖现有数据，确定继续吗？')) {
                                return;
                            }
                            
                            // 保存到localStorage
                            localStorage.setItem('userData', JSON.stringify(jsonData));
                            
                            showStatus('数据导入成功', 'success');
                            
                            // 更新数据预览
                            dataPreview.textContent = JSON.stringify(jsonData, null, 2);
                            dataPreview.classList.remove('hidden');
                        } catch (error) {
                            showStatus('无效的JSON文件: ' + error.message, 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                } else {
                    showStatus('请选择文件', 'error');
                }
            });

            // 显示简单的数据分析
            document.getElementById('analyze-data').addEventListener('click', () => {
                analyzeData();
            });
        });

        /**
         * 导出数据为指定格式
         * @param {string} format - 格式类型('json', 'csv', 'excel')
         */
        function exportData(format) {
            const userData = localStorage.getItem('userData');
            
            if (!userData) {
                showStatus('没有可导出的数据', 'error');
                return;
            }
            
            try {
                const data = JSON.parse(userData);
                
                switch(format) {
                    case 'json':
                        exportAsJson(data);
                        break;
                    case 'csv':
                        exportAsCsv(data);
                        break;
                    case 'excel':
                        showStatus('Excel导出功能需要额外的库支持，请先导出为CSV格式', 'warning');
                        exportAsCsv(data);
                        break;
                    default:
                        showStatus('不支持的导出格式', 'error');
                }
            } catch (error) {
                showStatus('数据导出失败: ' + error.message, 'error');
            }
        }

        /**
         * 导出为JSON文件
         */
        function exportAsJson(data) {
            // 创建一个Blob对象
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            
            // 创建下载链接
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = 'ai_art_experiment_' + new Date().toISOString().replace(/:/g, '-') + '.json';
            
            // 添加链接到页面，触发下载，然后移除链接
            document.body.appendChild(downloadLink);
            downloadLink.click();
            setTimeout(() => {
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(url);
            }, 100);
            
            showStatus('JSON数据导出成功', 'success');
        }

        /**
         * 导出为CSV文件
         */
        function exportAsCsv(data) {
            if (!data.experimentData || !data.experimentData.ratings || data.experimentData.ratings.length === 0) {
                showStatus('没有评分数据可以导出', 'error');
                return;
            }
            
            const ratings = data.experimentData.ratings;
            
            // CSV头
            const headers = [
                'userId', 'timestamp', 'group', 'imageId', 'imageType', 'imageCategory',
                'moralDisgust', 'technicalFlaws', 'originality', 'emotional', 'visualAppeal',
                'age', 'occupation', 'artExperience', 'aiAttitude', 'deviceType'
            ];
            
            // 构建CSV内容
            let csvContent = headers.join(',') + '\n';
            
            ratings.forEach(rating => {
                const row = [
                    rating.userId || '',
                    rating.timestamp || '',
                    rating.group || '',
                    rating.imageId || '',
                    rating.imageType || '',
                    rating.imageCategory || '',
                    rating.moralDisgust || '',
                    rating.technicalFlaws || '',
                    rating.originality || '',
                    rating.emotional || '',
                    rating.visualAppeal || '',
                    rating.age || '',
                    rating.occupation || '',
                    rating.artExperience || '',
                    rating.aiAttitude || '',
                    rating.deviceType || ''
                ];
                
                // 处理CSV中的特殊字符
                const escapedRow = row.map(cell => {
                    // 如果单元格包含逗号、双引号或换行符，则用双引号包裹并转义内部的双引号
                    if (cell && (cell.includes(',') || cell.includes('"') || cell.includes('\n'))) {
                        return `"${cell.replace(/"/g, '""')}"`;
                    }
                    return cell;
                });
                
                csvContent += escapedRow.join(',') + '\n';
            });
            
            // 创建Blob对象
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // 创建下载链接
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = 'ai_art_ratings_' + new Date().toISOString().replace(/:/g, '-') + '.csv';
            
            // 添加链接到页面，触发下载，然后移除链接
            document.body.appendChild(downloadLink);
            downloadLink.click();
            setTimeout(() => {
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(url);
            }, 100);
            
            showStatus('CSV数据导出成功', 'success');
            
            // 如果有注意力检测数据，也导出
            if (data.experimentData.attentionResults && data.experimentData.attentionResults.length > 0) {
                exportAttentionData(data.experimentData.attentionResults);
            }
        }

        /**
         * 导出注意力检测数据为CSV
         */
        function exportAttentionData(attentionData) {
            // CSV头
            const headers = ['userId', 'timestamp', 'imageId', 'userAnswer', 'correctAnswer', 'isCorrect'];
            
            // 构建CSV内容
            let csvContent = headers.join(',') + '\n';
            
            attentionData.forEach(item => {
                const row = [
                    item.userId || '',
                    item.timestamp || '',
                    item.imageId || '',
                    item.userAnswer || '',
                    item.correctAnswer || '',
                    item.isCorrect ? 'true' : 'false'
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            // 创建Blob对象
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // 创建下载链接
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = 'attention_check_results_' + new Date().toISOString().replace(/:/g, '-') + '.csv';
            
            // 添加链接到页面，触发下载，然后移除链接
            document.body.appendChild(downloadLink);
            downloadLink.click();
            setTimeout(() => {
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(url);
            }, 100);
        }

        /**
         * 对数据进行简单分析
         */
        function analyzeData() {
            const userData = localStorage.getItem('userData');
            
            if (!userData) {
                showStatus('没有可分析的数据', 'error');
                return;
            }
            
            try {
                const data = JSON.parse(userData);
                
                if (!data.experimentData || !data.experimentData.ratings || data.experimentData.ratings.length === 0) {
                    showStatus('没有评分数据可以分析', 'error');
                    return;
                }
                
                const ratings = data.experimentData.ratings;
                const resultsContainer = document.getElementById('analysis-results');
                
                if (!resultsContainer) {
                    showStatus('未找到结果容器', 'error');
                    return;
                }
                
                // 按组别分组数据
                const groupA = ratings.filter(r => r.group === 'A');
                const groupB = ratings.filter(r => r.group === 'B');
                const groupMixed = ratings.filter(r => r.group === 'Mixed');
                
                // 计算各维度平均分
                const dimensions = ['moralDisgust', 'technicalFlaws', 'originality', 'emotional', 'visualAppeal'];
                const dimensionLabels = {
                    'moralDisgust': '道德厌恶',
                    'technicalFlaws': '技术缺陷感知',
                    'originality': '原创性质疑',
                    'emotional': '情感共鸣',
                    'visualAppeal': '视觉吸引力'
                };
                
                // 整体平均分
                const overall = {};
                dimensions.forEach(dim => {
                    overall[dim] = calculateAverage(ratings, dim);
                });
                
                // 各组平均分
                const groupAverages = {
                    'A': {},
                    'B': {},
                    'Mixed': {}
                };
                
                dimensions.forEach(dim => {
                    groupAverages['A'][dim] = calculateAverage(groupA, dim);
                    groupAverages['B'][dim] = calculateAverage(groupB, dim);
                    groupAverages['Mixed'][dim] = calculateAverage(groupMixed, dim);
                });
                
                // 按图片类型分组
                const aiImages = ratings.filter(r => r.imageType === 'ai');
                const humanImages = ratings.filter(r => r.imageType === 'human');
                
                const typeAverages = {
                    'ai': {},
                    'human': {}
                };
                
                dimensions.forEach(dim => {
                    typeAverages['ai'][dim] = calculateAverage(aiImages, dim);
                    typeAverages['human'][dim] = calculateAverage(humanImages, dim);
                });
                
                // 统计注意力检测结果
                let attentionCorrectCount = 0;
                let attentionTotalCount = 0;
                
                if (data.experimentData.attentionResults) {
                    attentionTotalCount = data.experimentData.attentionResults.length;
                    attentionCorrectCount = data.experimentData.attentionResults.filter(r => r.isCorrect).length;
                }
                
                // 构建HTML输出
                let html = '<h3>数据分析结果</h3>';
                
                html += `<p><strong>总评分数:</strong> ${ratings.length}</p>`;
                html += `<p><strong>注意力检测正确率:</strong> ${attentionTotalCount > 0 ? Math.round((attentionCorrectCount / attentionTotalCount) * 100) : 0}% (${attentionCorrectCount}/${attentionTotalCount})</p>`;
                
                // 整体平均分
                html += '<h4>整体平均评分</h4><ul>';
                dimensions.forEach(dim => {
                    html += `<li>${dimensionLabels[dim]}: ${overall[dim].toFixed(2)}</li>`;
                });
                html += '</ul>';
                
                // 各组平均分
                html += '<h4>各组平均评分</h4>';
                
                // 创建表格
                html += '<table class="data-table"><thead><tr><th>维度</th><th>A组 (AI)</th><th>B组 (人类)</th><th>混合组</th></tr></thead><tbody>';
                
                dimensions.forEach(dim => {
                    html += `<tr>
                        <td>${dimensionLabels[dim]}</td>
                        <td>${groupAverages['A'][dim].toFixed(2)}</td>
                        <td>${groupAverages['B'][dim].toFixed(2)}</td>
                        <td>${groupAverages['Mixed'][dim].toFixed(2)}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                
                // 按图片类型
                html += '<h4>按图片类型平均评分</h4>';
                html += '<table class="data-table"><thead><tr><th>维度</th><th>AI生成</th><th>人类创作</th></tr></thead><tbody>';
                
                dimensions.forEach(dim => {
                    html += `<tr>
                        <td>${dimensionLabels[dim]}</td>
                        <td>${typeAverages['ai'][dim].toFixed(2)}</td>
                        <td>${typeAverages['human'][dim].toFixed(2)}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                
                resultsContainer.innerHTML = html;
            } catch (error) {
                showStatus('数据分析失败: ' + error.message, 'error');
            }
        }

        /**
         * 计算平均分
         * @param {Array} data - 数据数组
         * @param {string} dimension - 维度名称
         * @returns {number} - 平均分
         */
        function calculateAverage(data, dimension) {
            const sum = data.reduce((acc, item) => acc + (item[dimension] || 0), 0);
            return sum / data.length;
        }

        /**
         * 添加基本统计信息
         * @param {Object} data - 数据对象
         */
        function addBasicStatistics(data) {
            if (!data.experimentData || !data.experimentData.ratings) {
                return;
            }
            
            const ratings = data.experimentData.ratings;
            const totalRatings = ratings.length;
            const totalUsers = new Set(ratings.map(r => r.userId)).size;
            
            data.statistics = {
                totalRatings,
                totalUsers
            };
        }

        /**
         * 显示状态消息
         * @param {string} message - 消息内容
         * @param {string} type - 消息类型('success', 'error', 'warning')
         */
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message ' + type;
            statusMessage.classList.remove('hidden');
            
            // 5秒后自动隐藏
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>